---
- name: deploy calci frontend
  vars:
    frontend:
      image: "{{  lookup('env', 'RELATED_IMAGE_FRONTEND') }}"
  k8s:
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: flaskcalculator
        namespace: "{{ ansible_operator_meta.namespace }}"
        labels:
          app: flaskcalculator
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: flaskcalculator
        template:
          metadata:
            labels:
              app: flaskcalculator  
          spec:
            serviceAccount: my-python-app
            containers:
            - name: flaskcalculator
              image: "{{ frontend.image }}"
              imagePullPolicy: Always
              ports:
              - name: flaskcalculator
                containerPort: 5000
              securityContext: {}
          serviceAccountName: my-python-app
          serviceAccount: my-python-app
        strategy:
          type: Recreate
- name: create service for flaskcalculator
  k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata: 
        name: flaskservice
        namespace: '{{ ansible_operator_meta.namespace }}'
        labels:
          app: flaskcalculator
      spec:
        selector:
          app: flaskcalculator
        ports:
          - protocol: TCP
            port: 5001
            targetPort: 5000
- name: create route for flaskcalculator
  k8s:
    definition:
      apiVersion: route.openshift.io/v1
      kind: Route
      metadata:
        name: flaskroute
        namespace: '{{ ansible_operator_meta.namespace }}'
        labels:
          app: flaskcalculator
      spec:
        path: /
        to:
          kind: Service
          name: flaskservice
          weight: 100
        port:
          targetPort: 5001
